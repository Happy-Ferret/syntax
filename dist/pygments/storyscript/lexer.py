from pygments.lexer import RegexLexer, bygroups
from pygments.token import *

import re

__all__=['StoryscriptLexer']

class StoryscriptLexer(RegexLexer):
    name = 'Storyscript'
    aliases = ['Storyscript']
    filenames = ['*.story', '*.storyscript']
    flags = re.MULTILINE | re.UNICODE

    tokens = {
        'root' : [
            (u'(###)', bygroups(Comment), 'multi_line_comment__1'),
            (u'(#.*)', bygroups(Comment)),
            (u'(break|as|catch|returns?|continue|else|finally|if|then|try|when|while|foreach|pass|import)', bygroups(Keyword)),
            (u'(=)', bygroups(Operator)),
            (u'(\\()', bygroups(Punctuation), 'scope__1'),
            (u'(function)', bygroups(Keyword), 'function__1'),
            (u'\\b((0([box])[0-9a-fA-F]+)|([0-9]+(\\.[0-9]+)?(e[+\\-]?[0-9]+)?))\\b', bygroups(Number)),
            (u'(\\\'{3})', bygroups(String), 'string_single_triple__1'),
            (u'(\\\"{3})', bygroups(String), 'string_double_triple__1'),
            (u'(\\\')', bygroups(String), 'string_single__1'),
            (u'(\\\")', bygroups(String), 'string_double__1'),
            (u'(\\{)', bygroups(Punctuation), 'map__1'),
            (u'(null)', bygroups(Keyword.Constant)),
            (u'(\\[)', bygroups(Punctuation), 'list__1'),
            (u'(\\/(?![\\s=/*+{}?])(\\\\.|.)*?/[igmy]{0,4}(?![a-zA-Z0-9]))', bygroups(String.Regex)),
            (u'(true|false)', bygroups(Keyword.Constant)),
            (u'(#.*)', bygroups(Comment)),
            (u'([\\w_]+(?=\\s*:))', bygroups(Name), 'keyvalue__1'),
            (u'([\\w_]+[\\w_-]*/[\\w_]+[\\w_-]*)', bygroups(Name.Variable)),
            (u'([\\w_]+)', bygroups(Generic)),
            (u'(\\.[\\w_]+)', bygroups(Generic)),
            (u'(\\()', bygroups(Punctuation), 'scope__1'),
            (u'(<\\=|>\\=|\\=\\=|<|>|\\!\\=)', bygroups(Operator)),
            (u'(\\+|\\-|\\*|\\*\\*|/|//|%|<<|>>|&|\\||\\^|~|(?!^)@)', bygroups(Operator)),
            (u'([^\\s\\n\\r])', bygroups(Generic.Error)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'function__1' : [
            ('(\n|\r|\r\n)', String),
            ('.', Keyword),
        ], 
        'keytype__1' : [
            (u'(int|string|boolean|map|list|object)', bygroups(Keyword.Type)),
            (u'(:)', bygroups(Punctuation)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'keyvalue__1' : [
            ('(\n|\r|\r\n)', String),
            ('.', Name),
        ], 
        'list__1' : [
            (u'(\\,)', bygroups(Punctuation)),
            (u'\\b((0([box])[0-9a-fA-F]+)|([0-9]+(\\.[0-9]+)?(e[+\\-]?[0-9]+)?))\\b', bygroups(Number)),
            (u'(\\\'{3})', bygroups(String), 'string_single_triple__1'),
            (u'(\\\"{3})', bygroups(String), 'string_double_triple__1'),
            (u'(\\\')', bygroups(String), 'string_single__1'),
            (u'(\\\")', bygroups(String), 'string_double__1'),
            (u'(\\{)', bygroups(Punctuation), 'map__1'),
            (u'(null)', bygroups(Keyword.Constant)),
            (u'(\\[)', bygroups(Punctuation), 'list__1'),
            (u'(\\/(?![\\s=/*+{}?])(\\\\.|.)*?/[igmy]{0,4}(?![a-zA-Z0-9]))', bygroups(String.Regex)),
            (u'(true|false)', bygroups(Keyword.Constant)),
            (u'(#.*)', bygroups(Comment)),
            (u'([\\w_]+(?=\\s*:))', bygroups(Name), 'keyvalue__1'),
            (u'([\\w_]+[\\w_-]*/[\\w_]+[\\w_-]*)', bygroups(Name.Variable)),
            (u'([\\w_]+)', bygroups(Generic)),
            (u'(\\.[\\w_]+)', bygroups(Generic)),
            (u'(\\()', bygroups(Punctuation), 'scope__1'),
            (u'(<\\=|>\\=|\\=\\=|<|>|\\!\\=)', bygroups(Operator)),
            (u'(\\+|\\-|\\*|\\*\\*|/|//|%|<<|>>|&|\\||\\^|~|(?!^)@)', bygroups(Operator)),
            (u'([^\\s\\n\\r])', bygroups(Generic.Error)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'map__1' : [
            (u'((?=[\\\"\\\'][\\w_]+[\\\"\\\']\\s*:\\s*))', bygroups(Generic), 'mapassign__1'),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'mapassign__1' : [
            (u'(\\,)', bygroups(Punctuation)),
            (u'(\\:)', bygroups(Punctuation)),
            (u'\\b((0([box])[0-9a-fA-F]+)|([0-9]+(\\.[0-9]+)?(e[+\\-]?[0-9]+)?))\\b', bygroups(Number)),
            (u'(\\\'{3})', bygroups(String), 'string_single_triple__1'),
            (u'(\\\"{3})', bygroups(String), 'string_double_triple__1'),
            (u'(\\\')', bygroups(String), 'string_single__1'),
            (u'(\\\")', bygroups(String), 'string_double__1'),
            (u'(\\{)', bygroups(Punctuation), 'map__1'),
            (u'(null)', bygroups(Keyword.Constant)),
            (u'(\\[)', bygroups(Punctuation), 'list__1'),
            (u'(\\/(?![\\s=/*+{}?])(\\\\.|.)*?/[igmy]{0,4}(?![a-zA-Z0-9]))', bygroups(String.Regex)),
            (u'(true|false)', bygroups(Keyword.Constant)),
            (u'(#.*)', bygroups(Comment)),
            (u'([\\w_]+(?=\\s*:))', bygroups(Name), 'keyvalue__1'),
            (u'([\\w_]+[\\w_-]*/[\\w_]+[\\w_-]*)', bygroups(Name.Variable)),
            (u'([\\w_]+)', bygroups(Generic)),
            (u'(\\.[\\w_]+)', bygroups(Generic)),
            (u'(\\()', bygroups(Punctuation), 'scope__1'),
            (u'(<\\=|>\\=|\\=\\=|<|>|\\!\\=)', bygroups(Operator)),
            (u'(\\+|\\-|\\*|\\*\\*|/|//|%|<<|>>|&|\\||\\^|~|(?!^)@)', bygroups(Operator)),
            (u'([^\\s\\n\\r])', bygroups(Generic.Error)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'multi_line_comment__1' : [
            ('(\n|\r|\r\n)', String),
            ('.', Comment),
        ], 
        'placeholder__1' : [
            (u'\\b((0([box])[0-9a-fA-F]+)|([0-9]+(\\.[0-9]+)?(e[+\\-]?[0-9]+)?))\\b', bygroups(Number)),
            (u'(\\\'{3})', bygroups(String), 'string_single_triple__1'),
            (u'(\\\"{3})', bygroups(String), 'string_double_triple__1'),
            (u'(\\\')', bygroups(String), 'string_single__1'),
            (u'(\\\")', bygroups(String), 'string_double__1'),
            (u'(\\{)', bygroups(Punctuation), 'map__1'),
            (u'(null)', bygroups(Keyword.Constant)),
            (u'(\\[)', bygroups(Punctuation), 'list__1'),
            (u'(\\/(?![\\s=/*+{}?])(\\\\.|.)*?/[igmy]{0,4}(?![a-zA-Z0-9]))', bygroups(String.Regex)),
            (u'(true|false)', bygroups(Keyword.Constant)),
            (u'(#.*)', bygroups(Comment)),
            (u'([\\w_]+(?=\\s*:))', bygroups(Name), 'keyvalue__1'),
            (u'([\\w_]+[\\w_-]*/[\\w_]+[\\w_-]*)', bygroups(Name.Variable)),
            (u'([\\w_]+)', bygroups(Generic)),
            (u'(\\.[\\w_]+)', bygroups(Generic)),
            (u'(\\()', bygroups(Punctuation), 'scope__1'),
            (u'(<\\=|>\\=|\\=\\=|<|>|\\!\\=)', bygroups(Operator)),
            (u'(\\+|\\-|\\*|\\*\\*|/|//|%|<<|>>|&|\\||\\^|~|(?!^)@)', bygroups(Operator)),
            (u'([^\\s\\n\\r])', bygroups(Generic.Error)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'scope__1' : [
            (u'\\b((0([box])[0-9a-fA-F]+)|([0-9]+(\\.[0-9]+)?(e[+\\-]?[0-9]+)?))\\b', bygroups(Number)),
            (u'(\\\'{3})', bygroups(String), 'string_single_triple__1'),
            (u'(\\\"{3})', bygroups(String), 'string_double_triple__1'),
            (u'(\\\')', bygroups(String), 'string_single__1'),
            (u'(\\\")', bygroups(String), 'string_double__1'),
            (u'(\\{)', bygroups(Punctuation), 'map__1'),
            (u'(null)', bygroups(Keyword.Constant)),
            (u'(\\[)', bygroups(Punctuation), 'list__1'),
            (u'(\\/(?![\\s=/*+{}?])(\\\\.|.)*?/[igmy]{0,4}(?![a-zA-Z0-9]))', bygroups(String.Regex)),
            (u'(true|false)', bygroups(Keyword.Constant)),
            (u'(#.*)', bygroups(Comment)),
            (u'([\\w_]+(?=\\s*:))', bygroups(Name), 'keyvalue__1'),
            (u'([\\w_]+[\\w_-]*/[\\w_]+[\\w_-]*)', bygroups(Name.Variable)),
            (u'([\\w_]+)', bygroups(Generic)),
            (u'(\\.[\\w_]+)', bygroups(Generic)),
            (u'(\\()', bygroups(Punctuation), 'scope__1'),
            (u'(<\\=|>\\=|\\=\\=|<|>|\\!\\=)', bygroups(Operator)),
            (u'(\\+|\\-|\\*|\\*\\*|/|//|%|<<|>>|&|\\||\\^|~|(?!^)@)', bygroups(Operator)),
            (u'([^\\s\\n\\r])', bygroups(Generic.Error)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'string_double__1' : [
            (u'(\\{\\s*)', bygroups(String.Other), 'placeholder__1'),
            (u'(.)', bygroups(String)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'string_double_triple__1' : [
            (u'(\\{\\s*)', bygroups(String.Other), 'placeholder__1'),
            (u'(.)', bygroups(String)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'string_single__1' : [
            (u'(\\{\\s*)', bygroups(String.Other), 'placeholder__1'),
            (u'(.)', bygroups(String)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ], 
        'string_single_triple__1' : [
            (u'(\\{\\s*)', bygroups(String.Other), 'placeholder__1'),
            (u'(.)', bygroups(String)),
            ('(\n|\r|\r\n)', String),
            ('.', String),
        ]
    }

